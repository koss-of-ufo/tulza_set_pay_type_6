<!doctype html>
<html lang="ru">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Bulk Sender Ultimate v4</title>
    <style>
        :root {
            --bg: #f3f4f6;
            --card: #fff;
            --muted: #64748b;
            --ok: #16a34a;
            --err: #ef4444;
            --info: #0ea5e9
        }

        body {
            font-family: Inter, system-ui, Segoe UI, Roboto, Arial;
            margin: 18px;
            background: var(--bg);
            color: #0f1724
        }

        .card {
            max-width: 1100px;
            margin: 12px auto;
            padding: 16px;
            border-radius: 10px;
            background: var(--card);
            box-shadow: 0 6px 20px rgba(2, 6, 23, 0.06)
        }

        h1 {
            font-size: 18px;
            margin: 0 0 8px
        }

        h2 {
            font-size: 16px;
            margin: 0 0 8px
        }

        h3 {
            font-size: 14px;
            margin: 0 0 8px
        }

        .row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap
        }

        .col {
            flex: 1;
            min-width: 220px
        }

        label {
            display: block;
            font-size: 13px;
            color: #111;
            margin-top: 8px
        }

        input[type=text],
        select,
        textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #e6e9ef;
            border-radius: 8px;
            font-size: 14px
        }

        textarea {
            min-height: 60px;
            resize: vertical
        }

        input[type=file] {
            margin-top: 8px
        }

        button {
            background: #0b74ff;
            color: #fff;
            border: 0;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600
        }

        button.secondary {
            background: #e6e9ef;
            color: #111
        }

        button.warn {
            background: var(--err);
            color: #fff
        }

        .controls {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 12px;
            flex-wrap: wrap
        }

        .small {
            font-size: 12px;
            color: var(--muted)
        }

        #previewBox,
        #logBox {
            margin-top: 12px;
            border-radius: 8px;
            padding: 10px;
            background: #0b1220;
            color: #e6eef9;
            max-height: 260px;
            overflow: auto
        }

        .line {
            padding: 6px;
            border-radius: 6px;
            margin-bottom: 6px;
            font-family: monospace;
            white-space: pre-wrap
        }

        .line.ok {
            background: rgba(22, 163, 74, 0.08);
            color: var(--ok);
            border: 1px solid rgba(22, 163, 74, 0.12)
        }

        .line.err {
            background: rgba(239, 68, 68, 0.06);
            color: var(--err);
            border: 1px solid rgba(239, 68, 68, 0.12)
        }

        .line.info {
            background: rgba(14, 165, 233, 0.06);
            color: var(--info);
            border: 1px solid rgba(14, 165, 233, 0.12)
        }

        .statusbar {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-top: 10px;
            flex-wrap: wrap
        }

        .pill {
            padding: 6px 8px;
            border-radius: 999px;
            background: #f1f5f9;
            font-weight: 600;
            font-size: 13px
        }

        .badge {
            font-weight: 700
        }

        .small-muted {
            font-size: 12px;
            color: #475569
        }

        .footer {
            margin-top: 12px;
            font-size: 13px;
            color: #475569
        }

        .hint {
            font-size: 12px;
            color: #475569;
            margin-top: 6px
        }

        .highlight-select {
            border: 2px solid #4a90e2;
            background: #f0f8ff;
            padding: 6px;
            border-radius: 6px;
            transition: 0.25s ease;
            font-weight: bold;
        }

        .highlight-select:focus {
            border-color: #1c6acc;
            background: #e6f2ff;
            box-shadow: 0 0 4px #4a90e2;
        }


        .parser-container {
            margin-top: 14px;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            background: #f8fafc;
        }

        .results-layout {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .result-column {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 0;
        }

        .result-card {
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            position: relative;
        }

        .result-card.main {
            border-left: 4px solid #16a34a;
        }

        .result-card.sql {
            border-left: 4px solid #0ea5e9;
        }

        .result-card.num-csv {
            border-left: 4px solid #0b74ff;
        }

        .result-card.uuid-main {
            border-left: 4px solid #7c3aed;
        }

        .result-card.uuid-sql {
            border-left: 4px solid #db2777;
        }

        .result-card.uuid-csv {
            border-left: 4px solid #f97316;
        }

        .result-card.grz-main {
            border-left: 4px solid #ef4444;
        }

        .result-card.grz-sql {
            border-left: 4px solid #dc2626;
        }

        .result-card.grz-csv {
            border-left: 4px solid #b91c1c;
        }

        .result-title {
            font-size: 12px;
            font-weight: 700;
            color: #334155;
        }

        .result-number {
            font-family: ui-monospace, monospace;
            font-size: 13px;
            word-break: break-all;
        }

        .count-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #16a34a;
            color: #fff;
            border-radius: 999px;
            padding: 2px 7px;
            font-size: 11px;
            font-weight: 700;
        }

        .status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
        }

        .status.success {
            background: rgba(22, 163, 74, .08);
            color: #16a34a;
        }

        .status.error {
            background: rgba(239, 68, 68, .08);
            color: #ef4444;
        }

        .debug {
            margin-top: 8px;
            border-radius: 8px;
            padding: 8px;
            background: #0b1220;
            color: #e6eef9;
            font-family: ui-monospace, monospace;
            font-size: 12px;
        }

        .query-button {
            background: #0b74ff;
            color: #fff;
            border: 0;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 2px;
        }

        .db-results-container {
            margin-top: 10px;
            padding: 10px;
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }

        .db-results-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .db-results-table th,
        .db-results-table td {
            border: 1px solid #e2e8f0;
            padding: 6px;
            text-align: left;
        }

        @media (max-width: 1024px) {
            .results-layout {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="card">
        <h1>Bulk Sender Ultimate v4‚Äî set_pay_type / grn+comment / pan-–ø–æ–∂–∏—Ä–∞—Ç–µ–ª—å</h1>
        <div class="small-muted">CSV –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å UUID (–≤ –ª—é–±–æ–º —Å—Ç–æ–ª–±—Ü–µ) –∏–ª–∏ –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–º –ø–æ–ª–µ UUID –º–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–ª—è—Ç—å –≤
            –ª—é–±–æ–º —Ñ–æ—Ä–º–∞—Ç–µ ‚Äî –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø–æ–ø—Ä–æ–±—É–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å.</div>

        <div class="row" style="margin-top:12px">
            <div class="col">
                <label>Request URL</label>
                <input id="url" type="text" value="http://10.2.201.200/api/ui/find-transactions/set_pay_type" />
            </div>

            <div class="col">
                <label>HTTP method</label>
                <select id="method">
                    <option>POST</option>
                    <option>PUT</option>
                    <option>PATCH</option>
                </select>
            </div>

            <div class="col">
                <label>Authorization (Bearer ...)</label>
                <input id="auth" type="text" placeholder="Bearer ..." />
            </div>
        </div>

        <div class="row">
            <div class="col">
                <label>Operation mode</label>
                <select id="mode" class="highlight-select">
                    <option value="pay_type">–°–º–µ–Ω–∏—Ç—å pay_type (body: { transaction_uuid, pay_type })</option>
                    <option value="grn_comment">–û—Ç–ø—Ä–∞–≤–∏—Ç—å grn + comment (body: { transaction_uuid, grn, comment })
                    </option>
                    <option value="pan_change">–°–º–µ–Ω–∏—Ç—å PAN (–ø–∞—Ä—Å–∏–Ω–≥ –∏–∑ —Ç–µ–∫—Å—Ç–∞) (body: { transaction_uuid, grn, comment
                        })</option>
                </select>
            </div>

            <div class="col">
                <label>Pay type (–µ—Å–ª–∏ —Ä–µ–∂–∏–º pay_type)</label>
                <input id="payType" type="text" value="5" />
            </div>

            <div class="col">
                <label>Delay –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ (ms)</label>
                <input id="delay" type="text" value="200" />
            </div>
        </div>

        <div class="row">
            <div class="col">
                <label>GRN (–µ—Å–ª–∏ —Ä–µ–∂–∏–º grn+comment)</label>
                <input id="grn" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä T732YE797" />
            </div>
            <div class="col">
                <label>COMMENT (–µ—Å–ª–∏ —Ä–µ–∂–∏–º grn+comment)</label>
                <input id="comment" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 8667" />
            </div>
            <div class="col">
                <label>UUID column name (–µ—Å–ª–∏ –≤ CSV header)</label>
                <input id="uuidCol" type="text" placeholder="transaction_uuid (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" />
                <div class="hint">–ï—Å–ª–∏ CSV –∏–º–µ–µ—Ç header ‚Äî —É–∫–∞–∂–∏—Ç–µ –∏–º—è —Å—Ç–æ–ª–±—Ü–∞; –∏–Ω–∞—á–µ —Å–∏—Å—Ç–µ–º–∞ –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è –Ω–∞–π—Ç–∏ UUID
                    –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>
            </div>
        </div>


        <div class="parser-container">
            <h2>üîç –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ø–∞—Ä—Å–µ—Ä (–∏–∑ parser-2)</h2>
            <div class="small-muted">–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –æ–±—Ä–∞—â–µ–Ω–∏—è, –∏–∑–≤–ª–µ–∫–∏—Ç–µ UUID/–ì–†–ù–ó/–ø–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
                –ø–µ—Ä–µ–Ω–µ—Å–∏—Ç–µ UUID –≤ –æ—Ç–ø—Ä–∞–≤–∫—É.</div>
            <label>GLPI Cookie (x-glpi-cookie)</label>
            <input id="glpiCookie" type="text" placeholder="PHPSESSID=...; glpi...=...">
            <div class="hint">Cookie –±–µ—Ä—ë–º –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞ (DevTools ‚Üí Application/Storage ‚Üí Cookies ‚Üí
                techsupport.megatoll.ru)</div>
            <div class="row" style="margin-top:12px">
                <div class="col">
                    <label>Ticket base</label>
                    <input id="ticketBase" type="text"
                        value="https://techsupport.megatoll.ru/front/ticket.form.php?id=" />
                </div>

                <div class="col">
                    <label>Ticket ID</label>
                    <input id="ticketId" type="text" placeholder="11353" />
                    <div class="hint">–ù—É–∂–µ–Ω –¥–æ—Å—Ç—É–ø –≤ GLPI (–±—ã—Ç—å –∑–∞–ª–æ–≥–∏–Ω–µ–Ω–Ω—ã–º –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ).</div>
                </div>

                <div class="col" style="display:flex;align-items:flex-end;gap:8px">
                    <button id="btnLoadTicket" type="button" class="secondary">üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç —Ç–∏–∫–µ—Ç–∞</button>
                </div>
            </div>


            <label style="margin-top:8px">üìù –¢–µ–∫—Å—Ç –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞</label>
            <textarea id="inputText" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—ã—Ä–æ–π —Ç–µ–∫—Å—Ç..."></textarea>

            <div id="result" style="display:none; margin-top:10px;">
                <div class="results-layout">
                    <div class="result-column">
                        <h3 style="color:#28a745;">üìú –ü–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è</h3>
                        <div class="result-card main" id="cardNumMain" onclick="copyNumber()">
                            <div class="count-badge" id="mainCount">0</div>
                            <div class="result-title">üì± –ù–æ–º–µ—Ä –ø–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è</div>
                            <div class="result-number" id="outputText"></div>
                        </div>
                        <div class="result-card sql" id="cardNumSql" onclick="copySQL()">
                            <div class="count-badge" id="sqlCount">0</div>
                            <div class="result-title">üíæ SQL IN (...)</div>
                            <div class="result-number" id="sqlOutput"></div>
                        </div>
                        <div class="result-card num-csv" id="cardNumCsv" onclick="copyNumCsv()">
                            <div class="count-badge" id="numCsvCount">0</div>
                            <div class="result-title">üìÑ CSV</div>
                            <div class="result-number" id="numCsvOutput"></div>
                        </div>
                        <button id="queryDbBtn" class="query-button" style="display:none;">üì° –ù–∞–π—Ç–∏ –ø–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –≤
                            –ë–î</button>
                    </div>
                    <div class="result-column">
                        <h3 style="color:#6f42c1;">üÜî UUID</h3>
                        <div class="result-card uuid-main" id="cardUuidMain" onclick="copyUUIDMain()">
                            <div class="count-badge" id="uuidMainCount">0</div>
                            <div class="result-title">üÜî UUID (–≥–ª–∞–≤–Ω—ã–π)</div>
                            <div class="result-number" id="uuidOutput"></div>
                        </div>
                        <div class="result-card uuid-sql" id="cardUuidSql" onclick="copyUUIDSQL()">
                            <div class="count-badge" id="uuidSqlCount">0</div>
                            <div class="result-title">üíæ SQL IN (UUID)</div>
                            <div class="result-number" id="uuidSqlOutput"></div>
                        </div>
                        <div class="result-card uuid-csv" id="cardUuidCsv" onclick="copyUUIDCsv()">
                            <div class="count-badge" id="uuidCsvCount">0</div>
                            <div class="result-title">üìÑ CSV UUID</div>
                            <div class="result-number" id="uuidCsvOutput"></div>
                        </div>
                        <button id="btnUseParsedUuids" class="secondary">‚û°Ô∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å UUID –≤ Sender</button>
                        <button id="btnFillGrnMode" class="secondary">‚öôÔ∏è –ü–æ–¥—Å—Ç–∞–≤–∏—Ç—å UUID + –ì–†–ù–ó –≤ grn+comment</button>
                    </div>
                    <div class="result-column">
                        <h3 style="color:#dc3545;">üöó –ì–†–ù–ó</h3>
                        <div class="result-card grz-main" id="cardGrzMain" onclick="copyGrzMain()">
                            <div class="count-badge" id="grzMainCount">0</div>
                            <div class="result-title">üöó –ì–†–ù–ó (–≥–ª–∞–≤–Ω—ã–π)</div>
                            <div class="result-number" id="grzOutput"></div>
                        </div>
                        <div class="result-card grz-sql" id="cardGrzSql" onclick="copyGrzSQL()">
                            <div class="count-badge" id="grzSqlCount">0</div>
                            <div class="result-title">üíæ SQL IN (–ì–†–ù–ó)</div>
                            <div class="result-number" id="grzSqlOutput"></div>
                        </div>
                        <div class="result-card grz-csv" id="cardGrzCsv" onclick="copyGrzCsv()">
                            <div class="count-badge" id="grzCsvCount">0</div>
                            <div class="result-title">üìÑ CSV –ì–†–ù–ó</div>
                            <div class="result-number" id="grzCsvOutput"></div>
                        </div>
                    </div>
                </div>
                <div id="status" class="status"></div>
                <div id="debug" class="debug"></div>
                <div id="dbResultsContainer" class="db-results-container" style="display:none;">
                    <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–∑ –ë–î</h3>
                    <div id="dbResultsOutput"></div>
                </div>
            </div>
        </div>

        <hr style="margin:12px 0">


        <div class="row">
            <div class="col">
                <label>–ò—Å—Ç–æ—á–Ω–∏–∫ UUID</label>
                <select id="source" class="highlight-select">
                    <option value="file">CSV / TXT —Ñ–∞–π–ª</option>
                    <option value="textarea">–ü–æ–ª–µ –≤–≤–æ–¥–∞ (textarea)</option>
                </select>

                <label style="margin-top:8px">CSV / TXT —Ñ–∞–π–ª (–æ–¥–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ –∏–ª–∏ —Ç–∞–±–ª–∏—Ü–∞)</label>
                <input id="csvFile" type="file" accept=".csv,.txt" />

            </div>

            <div class="col">
                <label>–ò–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ UUID –≤ –ø–æ–ª–µ (–ª—é–±–æ–π —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å:\\n, –∑–∞–ø—è—Ç–∞—è, ;, –ø—Ä–æ–±–µ–ª). –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç
                    header/–∫–æ–ª–æ–Ω–∫–∏.</label>
                <textarea id="textArea" placeholder="uuid1\nuuid2\n–∏–ª–∏ transaction_uuid,grn,..."></textarea>
            </div>

            <div class="col">
                <label>–û–ø—Ü–∏–∏</label>
                <div style="display:flex;gap:8px;flex-direction:column">
                    <label><input id="fastExtract" type="checkbox" checked /> –ë—ã—Å—Ç—Ä–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ UUID –∏–∑ –ª—é–±–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
                        (–Ω–∞–ø—Ä–∏–º–µ—Ä
                        smena-pan.txt)</label>
                    <label><input id="autoDownloadErrors" type="checkbox" /> –°–∫–∞—á–∞—Ç—å errors.csv –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</label>
                    <label><input id="skipPreview" type="checkbox" /> –ü—Ä–æ–ø—É—Å–∫–∞—Ç—å Preview –ø–µ—Ä–µ–¥ Send All (–Ω–µ
                        —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ)</label>
                    <label><input id="useFirstColIfHeader" type="checkbox" checked /> –ï—Å–ª–∏ header –Ω–µ —É–∫–∞–∑–∞–Ω ‚Äî –±—Ä–∞—Ç—å
                        –ø–µ—Ä–≤—É—é
                        –∫–æ–ª–æ–Ω–∫—É</label>
                </div>
            </div>
        </div>

        <div class="controls">
            <button id="btnPreview">Preview (–ø–µ—Ä–≤—ã–µ 10)</button>
            <button id="btnSendOne" class="secondary">Send 1 (—Ç–µ—Å—Ç)</button>
            <button id="btnSendAll">Send All</button>
            <button id="btnPause" class="secondary" disabled>Pause</button>
            <button id="btnStop" class="warn" disabled>Stop</button>
            <button id="btnDownloadErrors" class="secondary">–°–∫–∞—á–∞—Ç—å errors.csv</button>
            <button id="btnDownloadReport" class="secondary">–°–∫–∞—á–∞—Ç—å report.csv</button>
            <div style="margin-left:auto" class="small-muted">–°–æ–≤–µ—Ç: Preview ‚Üí Send 1 ‚Üí Send All</div>
        </div>

        <div class="statusbar">
            <div class="pill">–í—Å–µ–≥–æ: <span id="total" class="badge">0</span></div>
            <div class="pill" style="background:#ecfdf5">–£—Å–ø–µ—Ö: <span id="success" class="badge">0</span></div>
            <div class="pill" style="background:#fff1f2">–û—à–∏–±–∫–∏: <span id="fail" class="badge">0</span></div>
            <div class="pill">–ü—Ä–æ–≥—Ä–µ—Å—Å: <span id="progress" class="badge">0/0</span></div>
        </div>

        <h3 style="margin-top:12px">PREVIEW</h3>
        <div id="previewBox"></div>

        <h3 style="margin-top:12px">–õ–æ–≥–∏</h3>
        <div id="logBox"></div>

        <div class="footer">
            <div class="hint">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –≤ textarea: –ø—Ä–æ—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ UUID, CSV —Å header, —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏:
                –∑–∞–ø—è—Ç–∞—è, ;,
                –ø—Ä–æ–±–µ–ª—ã, —Ç–∞–±—ã, –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫–∏.</div>
        </div>
    </div>
    <script type="module" src="js/main.js"></script>
    <script type="module" src="js/parser/main.js"></script>
    <script type="module" src="js/ticket_parser.js"></script>
</body>

</html>